@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    var tokens = Antiforgery.GetAndStoreTokens(Context);
}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="xsrf-token" content="@tokens.RequestToken">
    <title>@ViewData["Title"] - Glimpse</title>
    <link rel="stylesheet" href="~/css/app.css">
    <script>
        // SSE connection with auto-reconnect
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        window.glimpseConnected = false;
        window.glimpseListeners = []; // Store listeners to re-attach on reconnect

        // Wrapper to register listeners that persist across reconnects
        window.onGlimpseEvent = function(event, handler) {
            window.glimpseListeners.push({ event, handler });
            window.glimpseEvents?.addEventListener(event, handler);
        };

        function connectSSE() {
            window.glimpseEvents = new EventSource('/api/progress/stream');

            // Re-attach all registered listeners
            window.glimpseListeners.forEach(({ event, handler }) => {
                window.glimpseEvents.addEventListener(event, handler);
            });

            window.glimpseEvents.onopen = () => {
                if (window.glimpseConnected) {
                    window.showToast?.('Reconnected!', 'success');
                }
                window.glimpseConnected = true;
            };
            window.glimpseEvents.onerror = () => {
                window.glimpseEvents.close();
                setTimeout(connectSSE, 3000);
            };
        }
        connectSSE();
        window.addEventListener('beforeunload', () => window.glimpseEvents?.close());
    </script>
</head>
<body class="bg-dark-950 text-dark-100 min-h-screen antialiased scrollbar-thin">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 backdrop-blur-xl bg-dark-950/80 border-b border-dark-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="/" class="flex items-center group">
                        <span class="text-xl font-semibold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">Glimpse</span>
                    </a>
                    <div class="flex items-center gap-2 text-dark-500 text-sm">
                        <span>Screenshot OCR Search</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                @RenderBody()
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t border-dark-800 py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-dark-600 text-sm">
                Glimpse â€” Find any screenshot instantly
            </div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2"></div>

    <script>
        // Browser notifications for new screenshots (works on all pages)
        onGlimpseEvent('screenshot', (e) => {
            const s = JSON.parse(e.data);
            if ('Notification' in window && Notification.permission === 'granted') {
                const n = new Notification('Screenshot indexed', {
                    body: s.Filename,
                    icon: '/screenshots/' + s.Filename,
                    tag: 'screenshot-' + s.Id
                });
                n.onclick = () => {
                    window.focus();
                    window.location.href = '/detail/' + s.Id;
                    n.close();
                };
            }
        });
    </script>

    <script>
        // XSRF-protected fetch wrapper for state-changing requests
        window.apiFetch = function(url, options = {}) {
            const method = (options.method || 'GET').toUpperCase();
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                const token = document.querySelector('meta[name="xsrf-token"]')?.content;
                if (token) {
                    options.headers = {
                        ...options.headers,
                        'X-XSRF-TOKEN': token
                    };
                }
            }
            return fetch(url, options);
        };
    </script>

    <script>
        // Copy image to clipboard using browser API
        async function copyImageToClipboard(src) {
            try {
                const response = await fetch(src);
                const blob = await response.blob();
                await navigator.clipboard.write([
                    new ClipboardItem({ [blob.type]: blob })
                ]);
                showToast('Copied to clipboard!', 'success');
            } catch (e) {
                console.error('Clipboard error:', e);
                showToast('Failed to copy - try right-click and copy', 'error');
            }
        }

        // Toast
        window.showToast = function(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' 
                ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400'
                : 'bg-red-500/10 border-red-500/50 text-red-400';
            toast.className = `px-4 py-3 rounded-xl border backdrop-blur-xl ${colors} transform translate-x-full opacity-0 transition-all duration-300`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    ${type === 'success' 
                        ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                        : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
                    }
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
